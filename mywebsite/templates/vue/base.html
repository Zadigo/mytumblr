<script>
    var mixins = {
        methods: {
            buildurl: function (state, data) {
                if (state === "follow") {
                    return "/feed/u/" + data + "/follow"
                } 
                
                if (state === "unfollow") {
                    return "/feed/u/" + data + "/unfollow"
                }
            },
            follow: function (state, data) {
                var self = this
                // console.log(state, data)
                // var baseurl = "/feed/u/{{ user_feed.username }}/follow"

                // if (method === "unfollow") {
                //     baseurl = "/feed/u/{{ user_feed.username }}/unfollow"
                // }

                var url = self.buildurl(state, data)
                // console.log(url)
                self.$data.clicked = true
                fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    credentials: "same-origin"
                }).then((response) => {
                    response.json().then((response) => {
                        console.log(response)
                    })
                    setTimeout(() => {
                        self.$data.clicked = false
                    }, 1000);
                    self.$emit("follow", "unfollow", self.$props.data)
                }).catch((e) => {
                    setTimeout(() => {
                        self.$data.clicked = false
                    }, 1000);
                    console.log(e)
                })
            }
        }
    }

    var followbutton = {
        props: ["data"],
        name: "Follow",
        delimiters: ["[[", "]]"],
        mixins: [mixins],
        template: `
        <button-component @returnstate="domethod" 
            :extra_class="'btn-sm btn-outline-danger'" 
                :clicked="clicked" :name="'Follow'" />
        `,
        data() {
            return {
                clicked: false
            }
        },
        methods: {
            domethod: function () {
                this.follow("follow", this.$props.data)
            }
        }
    }

    var unfollowbutton = {
        props: ["data"],
        name: "Unfollow",
        delimiters: ["[[", "]]"],
        mixins: [mixins],
        template: `
        <button-component @returnstate="domethod" 
            :extra_class="'btn-sm btn-outline-danger'" 
                :clicked="clicked" :name="'Unfollow'" />
        `,
        data() {
            return {
                clicked: false
            }
        },
        methods: {
            domethod: function () {
                this.follow("unfollow", this.$props.data)
            }
        }
    }

    var singlefollowbutton = {
        props: ["data", "state"],
        name: "FollowForCards",
        delimiters: ["[[", "]]"],
        mixins: [mixins],
        template: `
        <button-component @returnstate="domethod" 
            :extra_class="'btn-sm btn-outline-danger'" 
                :clicked="clicked" :name="'Follow'" />
        `,
        data() {
            return {
                clicked: false
            }
        },
        methods: {
            domethod: function () {
                // console.log(this.$props.state, this.$props.data)
                this.follow("follow", this.$props.data)
            }
        }

    }

    var singleunfollowbutton = {
        props: ["data", "state"],
        name: "UnfollowForCards",
        delimiters: ["[[", "]]"],
        mixins: [mixins],
        template: `
        <button-component @returnstate="domethod" 
            :extra_class="'btn-sm btn-outline-danger'" 
                :clicked="clicked" :name="'Unfollow'" />
        `,
        data() {
            return {
                clicked: false
            }
        },
        methods: {
            domethod: function () {
                console.log(this.$props.state, this.$props.data)
                this.follow("unfollow", this.$props.data)
            }
        }
    }

    var videocards = {
        props: ["videos"],
        name: "ViideoCards",
        delimiters: ["[[", "]]"]
    }

    var usercards = {
        props: ["users"],
        name: "UserCards",
        delimiters: ["[[", "]]"],
        components: {
            "single-follow-button": singlefollowbutton,
            "single-unfollow-button": singleunfollowbutton
        },
        methods: {
            changesinglestate: function (id, method) {
                this.$emit("changesinglestate", id, method)
            }
        }
    }

    var feedapp = new Vue({
        el: "#vue_feed_app",
        name: "Feed",
        delimiters: ["[[", "]]"],
        components: {
            "video-cards-component": videocards,
            "user-cards-component": usercards,
            "follow-button": followbutton,
            "unfollow-button": unfollowbutton,

            "follow-cards-button": singlefollowbutton,
            "unfollow-cards-button": singleunfollowbutton,
        },
        data() {
            return {
                videos: [],
                suggestedusers: [],
                // userfeedstate: "follow"
                userfeedstate: "{% if user.myuserprofile in user_feed.myuserprofile.followed_by.all %}unfollow{% else %}follow{% endif %}"
            }
        },
        beforeMount() {
            // VIDEOS
            for (let i = 0; i < 100; i++) {
                this.$data.videos.push(
                    {id: i, url: "./assets/1.jpg"}
                )                   
            }

            // USERS
            for (let i = 0; i < 20; i++) {
                this.$data.suggestedusers.push(
                    { id: i, url: "./assets/2.jpg", state: "Follow" }
                )
            }
        },
        computed: {
            currentstate() {
                if (this.$data.userfeedstate === "follow") {
                    return "follow-button"
                }
                if (this.$data.userfeedstate === "unfollow") {
                    return "unfollow-button"
                }
            }
        },
        methods: {
            shiftstate: function (state) {
                this.$data.userfeedstate = state
            },
            dochange: function (id, method) {
                var user = _.find(this.$data.suggestedusers, function (user) { 
                    return user.id === id
                })
                
                if (method === "Follow") {
                    user.state = "Unfollow"
                }
                if (method === "Unfollow") {
                    user.state = "Follow"
                }
            },

            addlike: function (id, el) {
                // console.log(id, el)
                fetch("{% url 'feed:like' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ 'id': id })
                }).then((response) => {
                    if (response.status === 200) {
                        response.json().then((e) => {
                            var item = el.querySelector("i[id$='" + id + "']")
                            if (item.classList.contains("red-text")) {
                                item.classList.remove("red-text")
                            } else {
                                item.classList.add("red-text")
                            }

                            var item = el.querySelector("small[id$='" + id + "']")
                            item.textContent = e.total_likes

                            // var items = document.querySelectorAll("i[id^=like]")
                            // var itemid = "like-" + id
                            // items.forEach((item) => { 
                            //     if (item.getAttribute("id") === itemid) { 
                            //         if (item.classList.contains("red-text")) {
                            //             item.classList.remove("red-text")
                            //         } else {
                            //             item.classList.add("red-text") 
                            //         }
                            //     } 
                            // })

                            // var items = document.querySelectorAll("small[id^=likes-count]")
                            // var itemid = "likes-count-" + id
                            // items.forEach((item) => {
                            //     if (item.getAttribute("id") === itemid) {
                            //         item.textContent = e.total_likes
                            //     }
                            // })
                        })
                    } else {
                        window.location.reload()
                    }
                }).catch((error) => {
                    console.log(error)
                })
            },
            newcomment: function (id) {
                var self = this
                fetch("{% url 'feed:comment' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ 'id': id, 'text': self.$data.newmessage })
                }).then((response) => {
                    $("#new-comment-modal").modal("toggle")
                }).catch((error) => {
                    console.log(error)
                })
            },
            report: function (url, id) {
                fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    credentials: "same-origin",
                    body: JSON.stringify({ 'id': id })
                }).then((response) => {
                    if (response.status === 200) {

                    }
                }).catch((error) => {
                    console.log(error)
                })
            }
        }
    })
</script>
